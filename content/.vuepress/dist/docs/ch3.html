<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 3: Using Particle Integrations and Azure IoT Central | Particle &amp; Azure Workshop</title>
    <meta name="description" content="Workshops designed to teach the basics of IoT development with the Particle ecosystem &amp; the Particle Argon">
    
    
    <link rel="preload" href="/assets/css/6.styles.b7d182e7.css" as="style"><link rel="preload" href="/assets/js/app.c8901e43.js" as="script"><link rel="preload" href="/assets/js/1.a8f3b17b.js" as="script"><link rel="prefetch" href="/assets/js/0.93e73ff9.js"><link rel="prefetch" href="/assets/js/2.3969ea89.js"><link rel="prefetch" href="/assets/js/3.a9dc3cf8.js"><link rel="prefetch" href="/assets/js/4.db2e082b.js"><link rel="prefetch" href="/assets/js/5.3b722f3a.js">
    <link rel="stylesheet" href="/assets/css/6.styles.b7d182e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Particle &amp; Azure Workshop
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Team
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/particle-iot/particle-azure-workshop-2019" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Team
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/particle-iot/particle-azure-workshop-2019" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/docs/" class="sidebar-link">About Particle Workshops</a></li><li><a href="/docs/ch1.html" class="sidebar-link">Chapter 1: Getting your Particle Argon online</a></li><li><a href="/docs/ch2.html" class="sidebar-link">Chapter 2: Working with Particle Workbench, Primitives &amp; the Device Cloud</a></li><li><a href="/docs/ch3.html" class="active sidebar-link">Chapter 3: Integrations &amp; Azure IoT Central</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/ch3.html#exploring-the-particle-cli-and-device-cloud-api" class="sidebar-link">Exploring the Particle CLI and Device Cloud API</a></li><li class="sidebar-sub-header"><a href="/docs/ch3.html#integrating-with-azure-iot-central" class="sidebar-link">Integrating with Azure IoT Central</a></li></ul></li><li><a href="/docs/extra.html" class="sidebar-link">Extra: Going Even Further!</a></li></ul></div><div class="page"><div class="content"><h1 id="chapter-3-using-particle-integrations-and-azure-iot-central"><a href="#chapter-3-using-particle-integrations-and-azure-iot-central" aria-hidden="true" class="header-anchor">#</a> Chapter 3: Using Particle Integrations and Azure IoT Central</h1><table><thead><tr><th><strong>Project Goal</strong></th><th>Use Particle Integrations to connect your app to Azure IoT Central.</th></tr></thead><tbody><tr><td><strong>What you’ll learn</strong></td><td>Working with Particle Integrations, Integrating Particle projects with Azure IoT Central</td></tr><tr><td><strong>Tools you’ll need</strong></td><td>Particle Workbench, an <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> account, a Particle Argon, and the Grove Starter Kit for Particle Mesh, a Particle Debugger.</td></tr><tr><td><strong>Time needed to complete</strong></td><td>60 minutes</td></tr></tbody></table><p>In this session, you're going to explore the power of Particle integrations, integrate your project with Microsoft's Azure IoT Central and build dashboards to visualize your data. If you get stuck at any point during this session, <a href="TODO">click here for the completed, working source</a>.</p><p>First, let's take a brief look at the Particle CLI and Device Cloud API.</p><h2 id="exploring-the-particle-cli-and-device-cloud-api"><a href="#exploring-the-particle-cli-and-device-cloud-api" aria-hidden="true" class="header-anchor">#</a> Exploring the Particle CLI and Device Cloud API</h2><h3 id="the-particle-cli"><a href="#the-particle-cli" aria-hidden="true" class="header-anchor">#</a> The Particle CLI</h3><ol><li>If you haven't already, <a href="https://docs.particle.io/guide/tools-and-features/cli/photon/" target="_blank" rel="noopener noreferrer">install the Particle CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Open a terminal window and type the following command:</li></ol><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span> <span class="token function">curl</span> -sL https://particle.io/install-cli <span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>Type <code>particle login</code> and enter your Particle account email and password when prompted.</li></ol><p><img src="/assets/img/particlelogin.14fc48ea.gif" alt></p><ol start="3"><li>Once you're logged in, type <code>particle list</code> to see your list of online devices.</li></ol><p><img src="/assets/img/particlelist.085a96a6.gif" alt></p><ol start="4"><li>The device you've been using for this workshop has two variables and one function. Get the value of the <code>temp</code> variable with the command <code>particle get temp</code>.</li></ol><p><img src="/assets/img/temp.61c682e4.gif" alt></p><ol start="5"><li>You can also call one of the two functions to light up the yellow or blue LED button. Type the command <code>particle call &lt;your-device-name&gt; toggleLed</code> in the terminal. Run the same command again to turn the light off.</li></ol><h3 id="the-particle-device-cloud-api"><a href="#the-particle-device-cloud-api" aria-hidden="true" class="header-anchor">#</a> The Particle Device Cloud API</h3><p>Behind the scenes, every interface that Particle provides to work with devices, from the Console, to mobile apps, SDKs, and the CLI, they all talk through a RESTful Device Cloud API. You can even call yourself, directly.</p><p><em>The next few steps assume you have cURL installed on your machine. If you don't have this command-line utility on your machine, you can download and install it <a href="https://curl.haxx.se/download.html" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or use a GUI-based tool like <a href="https://www.getpostman.com/" target="_blank" rel="noopener noreferrer">Postman<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</em></p><ol><li><p>First, you'll need to obtain an access token from the CLI. Type <code>particle token list</code> to view the tokens associated with your account. The first one listed is your <code>user</code> token, and can be used to access the Device Cloud API. If no tokens are listed, generate a new one with <code>particle token new</code>.</p></li><li><p>With your token and Device ID in hand, type the following cURL command into a terminal window, replacing the text below in <code>&lt; &gt;</code> with your information.</p></li></ol><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> https://api.particle.io/v1/devices?access_token<span class="token operator">=</span><span class="token operator">&lt;</span>your token<span class="token operator">&gt;</span>
</code></pre></div><p>By default, the response will generate a wall of text in your terminal. If you have Python 2.6+ installed on your machine, you can pipe the output to the <code>json.tool</code> and get pretty-printed JSON.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> https://api.particle.io/v1/devices\?access_token\<span class="token operator">=</span><span class="token operator">&lt;</span>your token<span class="token operator">&gt;</span>
<span class="token operator">|</span> python -m json.tool
</code></pre></div><p><img src="/assets/img/curllist.d0d65fc2.gif" alt></p><ol start="3"><li><p>For this next command, you need the Device ID of the Photon attached to your badge. You can find that in the console or via the <code>particle list</code> CLI command.</p></li><li><p>Let's call the <code>toggleLed</code> function using the Device Cloud API. Type the following, again replacing the text below in <code>&lt; &gt;</code> with your information.</p></li></ol><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> https://api.particle.io/v1/devices/<span class="token operator">&lt;</span>device id<span class="token operator">&gt;</span>/toggleLED \
     -d access_token<span class="token operator">=</span><span class="token operator">&lt;</span>your token<span class="token operator">&gt;</span>
</code></pre></div><p><img src="/assets/img/curlcall.64f3b77c.gif" alt></p><p>You've now explored a number of ways that you can interface with the Particle Device cloud and your connected devices! Now, let's go beyond the Particle ecosystem and explore some of the ways that you can integrate with other 3rd party services, and backhaul your data into other cloud services.</p><h2 id="integrating-with-azure-iot-central"><a href="#integrating-with-azure-iot-central" aria-hidden="true" class="header-anchor">#</a> Integrating with Azure IoT Central</h2><p>In this section, you'll explore Azure IoT Central, create a middleware app to broker a connection between Particle and Azure, ingest data, and add simple visualizations. First, you'll need to set-up an IoT Central instance.</p><h3 id="setting-up-azure-iot-central"><a href="#setting-up-azure-iot-central" aria-hidden="true" class="header-anchor">#</a> Setting up Azure IoT Central</h3><ol><li>Sign up for an <a href="https://azure.microsoft.com/en-us/get-started/" target="_blank" rel="noopener noreferrer">Azure Account<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, or sign in if you already have one.</li></ol><p><img src="/assets/img/azureacct.d865c7cf.png" alt></p><ol start="2"><li>Navigate to the <a href="https://apps.azureiotcentral.com/build" target="_blank" rel="noopener noreferrer">Build Your IoT Application<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> section of IoT Central and select the &quot;Custom App&quot; template.</li></ol><p><img src="/assets/img/centralbuild.8746f59c.png" alt></p><ol start="3"><li>Give the IoT Central Application a name and URL (both must be globally unique). Then, select &quot;Custom application&quot; for the application template,  choose a pricing tier, select a subscription, and choose &quot;United States&quot; for the location. Finally, click &quot;Create&quot; and wait for the deployment to complete.</li></ol><p><img src="/assets/img/centralcreate.523c453e.png" alt></p><ol start="4"><li>When the deployment completes, you will be navigated to the newly deployed IoT Central Instance.</li></ol><p><img src="/assets/img/centralinstance.1fbb22ae.png" alt></p><ol start="5"><li>If you need to find the url to your IoT Central instance, you can view a list of all of the IoT Central instances for your subscription at https://apps.azureiotcentral.com/myapps</li></ol><p><img src="/assets/img/centralmyapps.fc156e18.png" alt></p><h3 id="adding-device-telemetry-and-commands"><a href="#adding-device-telemetry-and-commands" aria-hidden="true" class="header-anchor">#</a> Adding Device Telemetry and Commands</h3><ol start="6"><li>Click the &quot;Create Device Templates&quot; card on the home page. Click &quot;Custom&quot; in the next screen.</li></ol><p><img src="/assets/img/centralhome.bf1a5283.png" alt></p><ol start="7"><li>Name the template &quot;Particle Argon&quot; and click &quot;Create.&quot;</li></ol><p><img src="/assets/img/templatehome.02b7bb6b.png" alt></p><ol start="8"><li>Click the &quot;New&quot; menu option and select &quot;Telemetry.&quot;</li></ol><p><img src="/assets/img/addtelemetry.fcb4f6cc.png" alt></p><ol start="9"><li>Fill in the telemetry options using the data below and click &quot;Save.&quot;</li></ol><table><thead><tr><th>Display Name</th><th>Field Name</th><th>Units</th><th>Minimum Value</th><th>Maximum Value</th><th>Decimal Places</th></tr></thead><tbody><tr><td>Temperature</td><td>temp</td><td>degF</td><td>0</td><td>110</td><td>0</td></tr></tbody></table><p><img src="/assets/img/createtelemetry.73efb57e.png" alt></p><ol start="10"><li>Repeat steps 8-9 for humidity and light, using the values below.</li></ol><table><thead><tr><th>Display Name</th><th>Field Name</th><th>Units</th><th>Minimum Value</th><th>Maximum Value</th><th>Decimal Places</th></tr></thead><tbody><tr><td>Humidity</td><td>humidity</td><td>%</td><td>0</td><td>100</td><td>0</td></tr><tr><td>Light Level</td><td>light</td><td>%</td><td>0</td><td>100</td><td>2</td></tr></tbody></table><p>Once done, you'll start to see simulated data show up on the right side of the screen.</p><p><img src="/assets/img/alltelemetry.b9e9baba.png" alt></p><h3 id="creating-the-azure-iot-central-device-bridge-middleware"><a href="#creating-the-azure-iot-central-device-bridge-middleware" aria-hidden="true" class="header-anchor">#</a> Creating the Azure IoT Central Device Bridge Middleware</h3><p>To integrate Particle devices with IoT Central, you’ll need to set-up two things:</p><ol><li>Middleware (a public API or serverless app) to catch webhooks from Particle and forward data into IoT Central.</li><li>A Webhook integration to forward Particle events to your middleware.</li></ol><p>The middleware solution can be anything you like, and you can roll it yourself, but if, like us, you don’t enjoy spinning up sites from scratch just for fun, the Azure team provides an <a href="https://github.com/Azure/iotc-device-bridge" target="_blank" rel="noopener noreferrer">Azure IoT Central Device Bridge<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> template solution with one-click deployment into your Azure account.</p><p><img src="/assets/img/5-README.15aa3d7e.png" alt></p><ol><li><p>Navigate to the README for the project and click on the Deploy to Azure button. This opens up an Azure Marketplace template that’s preconfigured to add 4 resources to your Azure account: An Azure App Service and App Service plan for hosting the middleware app, a Key vault to hold your IoT Central tokens, and a Storage account.</p></li><li><p>To complete the deployment from the template, select a subscription, resource group, and location. Then, provide the Scope ID and SAS Key for your Central application. These can be obtained from the <code>Administration &gt; Device Connection</code> screen of your IoT Central application.</p></li></ol><p><img src="/assets/img/5-ScopeAndSAS.bcb7c6df.png" alt></p><ol start="3"><li>Once the deployment is done, you’ll have an App Service that can securely forward messages to your IoT Central instance. The App Service deployed by this template is a Node.js app, so the next step is to open your function app in the portal, run <code>npm install</code> to install dependencies and restart the app.</li></ol><p><img src="/assets/img/6-npminstall.0949633a.png" alt></p><ol start="4"><li>Once the app restarts, grab the function URL to set-up the webhook on the Particle side. For additional info on this or the last few steps, check out the <a href="https://github.com/Azure/iotc-device-bridge/blob/master/README.md" target="_blank" rel="noopener noreferrer"><code>README</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for the device bridge project.</li></ol><p>Now you're ready to create an integration between Particle and your middleware.</p><h3 id="creating-the-particle-integration"><a href="#creating-the-particle-integration" aria-hidden="true" class="header-anchor">#</a> Creating the Particle Integration</h3><ol><li>Head to the <a href="https://console.particle.io/" target="_blank" rel="noopener noreferrer">Particle Console<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and click on the integrations icon on the left gutter navigation.</li></ol><p><img src="/assets/img/7-Integrations.003d7bdd.png" alt></p><ol start="2"><li>Click the New Integration card, and then click the Webhook option. Be sure not to select the Azure IoT Hub integration.</li></ol><p><img src="/assets/img/8-IntOpts.f5fdf87f.png" alt></p><ol start="3"><li>In the Webhook builder, enter the name of the event you want to listen for on the particle side. Let's use <code>env-vals</code> since that's what we'll use in firmware in the next section. Then, paste in the URL from the Azure App Service function you created in the last step. Leave the request type unchanged and select JSON for the request format. In the last drop-down, select the Particle device you plan to publish events from.</li></ol><p><img src="/assets/img/9-Webhookbuilder.671f5be5.png" alt></p><ol start="4"><li>In order to get the request payload into a format that your App Service middleware can ingest and forward to IoT Central, you’ll need to customize the default webhook that Particle sends. So, before clicking Create Webhook, click the Advanced Settings link to reveal the request form fields. Click the Custom option button. Copy the snippet below and paste it into the textarea. You may get a <code>bad string</code> warning from the built-in validator, but you can ignore this message.</li></ol><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;device&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;deviceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{{{PARTICLE_DEVICE_ID}}}&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;measurements&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span>PARTICLE_EVENT_VALUE<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>After you’ve changed the payload, click Create Webhook. Now you’re ready to start publishing events through the Particle Device Cloud.</li></ol><h3 id="publishing-sensor-values-from-firmware"><a href="#publishing-sensor-values-from-firmware" aria-hidden="true" class="header-anchor">#</a> Publishing Sensor Values from Firmware</h3><p><strong><em>Skip this section if you completed the BLE Bonus section in Lab 2.</em></strong></p><p>Now, let's modify our firmware to publish Sensor values. First, we'll refactor our firmware to remove the <code>delay</code> in the loop. While the delay approach is common when getting started with creating embedded applications, it's a blocking operation. This means that any calls you make to the device during a delay may timeout before being received.</p><p>One common way to write periodic code without using <code>delay</code> is to use the built-in <code>millis()</code> function and keep track of the elapsed time between the last time you performed an operation (like a temp check) and the wait time between operations.</p><ol><li>First, let's add some global variables to hold the last check time and an interval. Add the following to the top of your project, outside of the <code>setup</code> and <code>loop</code>.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> previousCheckMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> checkInterval <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>Now, in the <code>loop</code>, add a local variable to hold the current time elapsed. The <code>millis()</code> function returns the number of milliseconds that have elapsed since your device began running the current program.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> currentMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>Next, remove the <code>delay</code> at the end of your loop function. Then, wrap the rest of the code with an if statement to see if the <code>checkInterval</code> time has elapsed.</li></ol><p>Make sure you also update the <code>previousCheckMillis</code> variable to the current <code>millis</code> time or this <code>if</code> statement will never evaluate to <code>true</code> after the first time it runs.</p><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>currentMillis <span class="token operator">-</span> previousCheckMillis <span class="token operator">&gt;</span> checkInterval<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  previousCheckMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* rest of Loop code here */</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Your <code>loop</code> should now look like this:</p><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> currentMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMillis <span class="token operator">-</span> previousCheckMillis <span class="token operator">&gt;</span> checkInterval<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    previousCheckMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dht<span class="token punctuation">.</span><span class="token function">getTempFarenheit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    humidity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dht<span class="token punctuation">.</span><span class="token function">getHumidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Serial<span class="token punctuation">.</span><span class="token function">printlnf</span><span class="token punctuation">(</span><span class="token string">&quot;Temp: %f&quot;</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">printlnf</span><span class="token punctuation">(</span><span class="token string">&quot;Humidity: %f&quot;</span><span class="token punctuation">,</span> humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> lightAnalogVal <span class="token operator">=</span> <span class="token function">analogRead</span><span class="token punctuation">(</span>A0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentLightLevel <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>lightAnalogVal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">4095.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentLightLevel <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;light-meter/level&quot;</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>currentLightLevel<span class="token punctuation">)</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="publishing-a-payload-with-temp-and-humidity-values"><a href="#publishing-a-payload-with-temp-and-humidity-values" aria-hidden="true" class="header-anchor">#</a> Publishing a payload with temp and humidity values</h3><p>Now, let's send the current temp, humidity and light level using a <code>Particle.publish</code> event. You'll send a single event with all three values in a single JSON object. To do this, you'll use the <code>JSONParserGenerator</code> library.</p><ol><li><p>Open the Workbench Command Palette (CMD+SHIFT+P or CTRL+SHIFT+P) and select the &quot;Particle: Install Library&quot; option.</p></li><li><p>In the text box, type &quot;JsonParserGeneratorRK&quot; and click enter.</p></li><li><p>At the top of your project, add an include statement:</p></li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;JsonParserGeneratorRK.h&quot;</span></span>
</code></pre></div><ol start="4"><li>Add a new function to your app called <code>createEventPayload</code> that takes the temp, humidity and light readings. This function will create an instance of <code>JsonWriterStatic</code> and <code>JsonWriterAutoObject</code> objects, insert key-value pairs for each reading, and then get the JSON object as a string buffer that you can send along in a <code>Particle.publish()</code> event.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">createEventPayload</span><span class="token punctuation">(</span><span class="token keyword">int</span> temp<span class="token punctuation">,</span> <span class="token keyword">int</span> humidity<span class="token punctuation">,</span> <span class="token keyword">double</span> light<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  JsonWriterStatic<span class="token operator">&lt;</span><span class="token number">256</span><span class="token operator">&gt;</span> jw<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    JsonWriterAutoObject <span class="token function">obj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jw<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;temp&quot;</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;humidity&quot;</span><span class="token punctuation">,</span> humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;light&quot;</span><span class="token punctuation">,</span> light<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>Now, let's publish a new event, and call the <code>createEventPayload</code> function to provide a formatted JSON string for the data parameter. Add the following to the end of your <code>createEventPayload</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;env-vals&quot;</span><span class="token punctuation">,</span> jw<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>Finally, add a call to this function at the end of your loop, just inside the end of the <code>if</code> statement.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">createEventPayload</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> humidity<span class="token punctuation">,</span> currentLightLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="7"><li>Now, flash this new code to your firmware, and when your device comes back online, you'll see events in your Console. You can also head to the integration you created above and view status logs to make sure that your integration and middleware are properly connected.</li></ol><h3 id="associating-devices-in-azure-iot-central"><a href="#associating-devices-in-azure-iot-central" aria-hidden="true" class="header-anchor">#</a> Associating Devices in Azure IoT Central</h3><p>Before we move on to creating dashboards and seeing our data stream in, we need to let IoT Central know that our device is legit. Once you’ve added the publish logic to your firmware and flashed a device, head back to your IoT Central application and associate the device to the template you created earlier.</p><ol><li><p>In the Devices window, you’ll see your template, and a link for Unassociated devices. Click that link, and if you see a device in the list with a name that matches the device id of your Particle device, you’ve configured everything successfully!</p></li><li><p>Click the checkbox next to the device, then click the Associate menu item on the top right.</p></li><li><p>Select your template and click Associate.</p></li></ol><p><img src="/assets/img/11-associate.5f1adfb0.png" alt></p><p>If your device is not showing up, double-check the previous configuration steps to make sure everything is correct, including the App service function URL, and that the App service is running. You can also view the response header logs for your Webhook integration in the Particle console for additional insight.</p><h3 id="building-visualizations-in-iot-central"><a href="#building-visualizations-in-iot-central" aria-hidden="true" class="header-anchor">#</a> Building Visualizations in IoT Central</h3><p>To build dashboard visualizations for our Particle Device, you'll need to edit the device template.</p><ol><li>Click on the &quot;Device Templates&quot; menu item in IoT Central and click on your &quot;Particle Argon&quot; template.</li></ol><p><img src="/assets/img/templates.320da835.png" alt></p><ol start="2"><li>Click the &quot;Dashboard&quot; menu item.</li></ol><p><img src="/assets/img/widgets.2ecc7e3c.png" alt></p><ol start="3"><li>Click the &quot;Last Known Value&quot; widget. In the configuration window, set the title to &quot;Last Temp,&quot; the measurement type to &quot;Telemetry&quot; and, in &quot;Measures&quot;, click the visibility icon next to &quot;Temperature&quot; to select it.</li></ol><p><img src="/assets/img/lasttemp.dba58560.png" alt></p><ol start="4"><li>Click save, and the widget will show up in the main panel, with simulated data.</li></ol><p><img src="/assets/img/lasttempsim.652de76e.png" alt></p><ol start="5"><li>Repeat steps 3 and 4 for the humidity and light sensor values.</li></ol><p><img src="/assets/img/allsensors.19d939a8.png" alt></p><ol start="6"><li>Now, click the &quot;Line Chart&quot; widget. In the configuration window, enter &quot;Env Vals&quot; as the title, set a time range to the past hour, and click the visibility icon for all three values to select them.</li></ol><p><img src="/assets/img/createchart.8fa90bad.png" alt></p><ol start="7"><li>Click save and the chart will be created, again with simulated data.</li></ol><p><img src="/assets/img/allwidgets.17c3d9a0.png" alt></p><ol start="8"><li>Click on the &quot;Devices&quot; left menu item, and select your real device. Click the &quot;Dashboard&quot; top menu item and you'll see the real values from your Particle Argon.</li></ol><p><img src="/assets/img/realdashboard.775b88ee.png" alt></p><hr><p><strong>Congratulations! You've completed this workshop. Now you're a Particle Master! Take a moment to pat yourself on the back and bask in your newfound IoT-commandery. And if you want to take your exploration further, click the &quot;Extra&quot; link below!</strong></p><p><strong>BEFORE YOU GO</strong> you'd love it if you could provide feedback on this workshop. Please visit <a href="https://particleiot.typeform.com/to/JiF8xM" target="_blank" rel="noopener noreferrer">this link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to rate your experience.</p></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/particle-iot/particle-azure-workshop-2019/edit/master/content/docs/ch3.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/docs/ch2.html" class="prev">
          Chapter 2: Working with Particle Workbench, Primitives &amp; the Device Cloud
        </a></span><span class="next"><a href="/docs/extra.html">
          Extra: Going Even Further!
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/1.a8f3b17b.js" defer></script><script src="/assets/js/app.c8901e43.js" defer></script>
  </body>
</html>
